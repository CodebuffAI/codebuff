#!/usr/bin/env bash

# Check if infisical is available
if command -v infisical >/dev/null 2>&1; then
  # Parse arguments: everything before -- goes to infisical, everything after goes to the command
  infisical_args=()
  command_args=()
  found_separator=false
  
  for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
      found_separator=true
      continue
    fi
    
    if [[ "$found_separator" == true ]]; then
      command_args+=("$arg")
    else
      infisical_args+=("$arg")
    fi
  done
  
  # If no separator found, treat all args as the command
  if [[ "$found_separator" == false ]]; then
    command_args=("$@")
    infisical_args=()
  fi
  
  # Default to --log-level=warn if no infisical args provided
  if [[ ${#infisical_args[@]} -eq 0 ]]; then
    infisical_args=("--log-level=warn")
  fi
  
  # Execute with infisical
  exec infisical run "${infisical_args[@]}" -- "${command_args[@]}"
else
  # No infisical - skip everything before -- and run command directly
  command_args=()
  found_separator=false
  
  for arg in "$@"; do
    if [[ "$arg" == "--" ]]; then
      found_separator=true
      continue
    fi
    
    if [[ "$found_separator" == true ]]; then
      command_args+=("$arg")
    fi
  done
  
  # If no separator found, treat all args as the command
  if [[ "$found_separator" == false ]]; then
    command_args=("$@")
  fi
  
  # Execute command directly
  exec "${command_args[@]}"
fi